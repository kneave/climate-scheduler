<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Climate Dialog Development Test</title>
  <script type="module" src="https://cdn.jsdelivr.net/npm/lit@3.1.0/+esm"></script>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 20px;
    }

    .control-panel {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      height: fit-content;
      position: sticky;
      top: 20px;
    }

    .control-panel h2 {
      margin-top: 0;
      font-size: 18px;
      color: #333;
      border-bottom: 2px solid #03a9f4;
      padding-bottom: 10px;
    }

    .feature-group {
      margin-bottom: 20px;
    }

    .feature-group h3 {
      font-size: 14px;
      color: #666;
      margin: 10px 0 8px 0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .checkbox-item:last-child {
      border-bottom: none;
    }

    .checkbox-item input[type="checkbox"] {
      margin-right: 10px;
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .checkbox-item label {
      cursor: pointer;
      flex: 1;
      font-size: 14px;
      color: #333;
    }

    .checkbox-item .bit-value {
      font-size: 11px;
      color: #999;
      font-family: monospace;
    }

    .preview-area {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .preview-area h2 {
      margin-top: 0;
      font-size: 18px;
      color: #333;
      border-bottom: 2px solid #03a9f4;
      padding-bottom: 10px;
    }

    .entity-info {
      background: #f9f9f9;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
      font-family: monospace;
      font-size: 12px;
    }

    .entity-info .label {
      font-weight: bold;
      color: #666;
    }

    .entity-info .value {
      color: #333;
    }

    .action-buttons {
      margin-top: 15px;
      display: flex;
      gap: 10px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #03a9f4;
      color: white;
    }

    .btn-primary:hover {
      background: #0288d1;
    }

    .btn-secondary {
      background: #e0e0e0;
      color: #333;
    }

    .btn-secondary:hover {
      background: #d0d0d0;
    }

    /* CSS Variables for HA theming */
    :root {
      --primary-color: #03a9f4;
      --accent-color: #ff9800;
      --disabled-text-color: #9b9b9b;
      --text-primary-color: #ffffff;
      --card-background-color: #ffffff;
      --primary-background-color: #fafafa;
      --secondary-background-color: #e5e5e5;
      --divider-color: rgba(0, 0, 0, 0.12);
      --ha-card-border-radius: 8px;
      --ha-font-size-xs: 10px;
      --ha-font-size-sm: 12px;
      --ha-font-size-md: 14px;
      --ha-font-size-lg: 16px;
      --ha-space-xs: 4px;
      --ha-space-sm: 8px;
      --ha-space-md: 12px;
      --ha-space-lg: 16px;
    }

    /* Modal overlay and dialog styles */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.2s ease-out;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-dialog {
      background: white;
      border-radius: 8px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      max-width: 650px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      animation: slideUp 0.3s ease-out;
      position: relative;
    }

    .modal-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background 0.2s;
      z-index: 1;
    }

    .modal-close:hover {
      background: #f0f0f0;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideUp {
      from {
        transform: translateY(20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="control-panel">
      <h2>üéõÔ∏è Feature Toggles</h2>
      
      <div class="feature-group">
        <h3>Temperature Control</h3>
        <div class="checkbox-item">
          <input type="checkbox" id="feat-1" value="1" class="temp-mode">
          <label for="feat-1">Target Temperature</label>
          <span class="bit-value">1</span>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="feat-2" value="2" checked class="temp-mode">
          <label for="feat-2">Temperature Range</label>
          <span class="bit-value">2</span>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="feat-4" value="4">
          <label for="feat-4">Target Humidity</label>
          <span class="bit-value">4</span>
        </div>
      </div>

      <div class="feature-group">
        <h3>Operation Modes</h3>
        <div class="checkbox-item">
          <input type="checkbox" id="feat-8" value="8" checked>
          <label for="feat-8">Fan Mode</label>
          <span class="bit-value">8</span>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="feat-16" value="16" checked>
          <label for="feat-16">Preset Mode</label>
          <span class="bit-value">16</span>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="feat-32" value="32">
          <label for="feat-32">Swing Mode (Vertical)</label>
          <span class="bit-value">32</span>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="feat-512" value="512">
          <label for="feat-512">Swing Horizontal</label>
          <span class="bit-value">512</span>
        </div>
      </div>

      <div class="feature-group">
        <h3>Power & Auxiliary</h3>
        <div class="checkbox-item">
          <input type="checkbox" id="feat-64" value="64">
          <label for="feat-64">Aux Heat</label>
          <span class="bit-value">64</span>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="feat-128" value="128" checked>
          <label for="feat-128">Turn Off</label>
          <span class="bit-value">128</span>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="feat-256" value="256" checked>
          <label for="feat-256">Turn On</label>
          <span class="bit-value">256</span>
        </div>
      </div>

      <div class="feature-group">
        <h3>HVAC Modes</h3>
        <div class="checkbox-item">
          <input type="checkbox" class="hvac-mode-toggle" id="mode-off" value="off" checked>
          <label for="mode-off">Off</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" class="hvac-mode-toggle" id="mode-heat" value="heat" checked>
          <label for="mode-heat">Heat</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" class="hvac-mode-toggle" id="mode-cool" value="cool" checked>
          <label for="mode-cool">Cool</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" class="hvac-mode-toggle" id="mode-heat-cool" value="heat_cool" checked>
          <label for="mode-heat-cool">Heat/Cool</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" class="hvac-mode-toggle" id="mode-auto" value="auto" checked>
          <label for="mode-auto">Auto</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" class="hvac-mode-toggle" id="mode-dry" value="dry">
          <label for="mode-dry">Dry</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" class="hvac-mode-toggle" id="mode-fan-only" value="fan_only">
          <label for="mode-fan-only">Fan Only</label>
        </div>
      </div>

      <div class="action-buttons">
        <button class="btn btn-primary" id="updateBtn">Update Dialog</button>
        <button class="btn btn-secondary" id="openModalBtn">Open as Modal</button>
        <button class="btn btn-secondary" id="resetBtn">Reset</button>
      </div>
    </div>

    <div class="preview-area">
      <h2>üì± Dialog Preview</h2>
      
      <div class="entity-info">
        <div><span class="label">Entity ID:</span> <span class="value" id="entityId">climate.test_hvac</span></div>
        <div><span class="label">State:</span> <span class="value" id="entityState">heat</span></div>
        <div><span class="label">Supported Features:</span> <span class="value" id="supportedFeatures">409</span></div>
        <div><span class="label">Current Temperature:</span> <span class="value" id="currentTemp">21.5¬∞C</span></div>
      </div>

      <climate-control-dialog></climate-control-dialog>
    </div>
  </div>

  <script type="module">
    import { LitElement, html, css } from 'https://cdn.jsdelivr.net/npm/lit@3.1.0/+esm';

    // Climate Entity Feature Enum
    const ClimateEntityFeature = {
      TARGET_TEMPERATURE: 1,
      TARGET_TEMPERATURE_RANGE: 2,
      TARGET_HUMIDITY: 4,
      FAN_MODE: 8,
      PRESET_MODE: 16,
      SWING_MODE: 32,
      AUX_HEAT: 64,
      TURN_OFF: 128,
      TURN_ON: 256,
      SWING_HORIZONTAL_MODE: 512,
    };

    // HVAC Modes
    const HVAC_MODES = ['off', 'heat', 'cool', 'heat_cool', 'auto', 'dry', 'fan_only'];
    
    // Helper function to check if feature is supported
    function supportsFeature(stateObj, feature) {
      return (stateObj.attributes.supported_features & feature) !== 0;
    }

    // Climate Control Dialog Component
    class ClimateControlDialog extends LitElement {
      static properties = {
        stateObj: { type: Object },
      };

      static styles = css`
        :host {
          display: block;
          background: var(--card-background-color, #fff);
          border-radius: var(--ha-card-border-radius, 8px);
          padding: 24px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .dialog-header {
          font-size: 20px;
          font-weight: 500;
          margin-bottom: 20px;
          color: #333;
          display: flex;
          align-items: center;
          gap: 12px;
        }

        .entity-icon {
          width: 40px;
          height: 40px;
          border-radius: 50%;
          background: var(--primary-color, #03a9f4);
          display: flex;
          align-items: center;
          justify-content: center;
          color: white;
          font-size: 20px;
        }

        .section {
          margin-bottom: 24px;
          padding-bottom: 16px;
          border-bottom: 1px solid var(--divider-color, #e0e0e0);
        }

        .section:last-child {
          border-bottom: none;
          margin-bottom: 0;
        }

        .section-title {
          font-size: 14px;
          font-weight: 600;
          color: #666;
          margin-bottom: 12px;
          text-transform: uppercase;
          letter-spacing: 0.5px;
        }

        .hvac-modes {
          display: flex;
          gap: 8px;
          flex-wrap: wrap;
        }

        .hvac-mode-btn {
          padding: 10px 16px;
          border: 2px solid var(--divider-color, #e0e0e0);
          border-radius: 20px;
          background: white;
          cursor: pointer;
          font-size: 14px;
          transition: all 0.2s;
          text-transform: capitalize;
        }

        .hvac-mode-btn:hover {
          border-color: var(--primary-color, #03a9f4);
        }

        .hvac-mode-btn.active {
          background: var(--primary-color, #03a9f4);
          color: white;
          border-color: var(--primary-color, #03a9f4);
        }

        .temperature-control {
          display: flex;
          align-items: center;
          gap: 16px;
          padding: 16px;
          background: #f9f9f9;
          border-radius: 8px;
        }

        .temp-display {
          font-size: 32px;
          font-weight: 300;
          min-width: 80px;
          text-align: center;
        }

        .temp-controls {
          display: flex;
          flex-direction: column;
          gap: 8px;
        }

        .temp-btn {
          width: 40px;
          height: 40px;
          border: none;
          border-radius: 50%;
          background: var(--primary-color, #03a9f4);
          color: white;
          cursor: pointer;
          font-size: 20px;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: all 0.2s;
        }

        .temp-btn:hover {
          background: #0288d1;
          transform: scale(1.05);
        }

        .temp-slider {
          flex: 1;
        }

        input[type="range"] {
          width: 100%;
          height: 6px;
          border-radius: 3px;
          background: #e0e0e0;
          outline: none;
          -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
          -webkit-appearance: none;
          appearance: none;
          width: 20px;
          height: 20px;
          border-radius: 50%;
          background: var(--primary-color, #03a9f4);
          cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
          width: 20px;
          height: 20px;
          border-radius: 50%;
          background: var(--primary-color, #03a9f4);
          cursor: pointer;
          border: none;
        }

        .temp-range-control {
          /* No background box */
        }

        .dual-range-container {
          position: relative;
          margin: 30px 0;
          padding: 0;
        }

        .dual-range-input {
          position: absolute;
          width: 100%;
          left: 0;
          pointer-events: none;
          -webkit-appearance: none;
          background: transparent;
          margin: 0;
          height: 20px;
        }

        .dual-range-input::-webkit-slider-thumb {
          -webkit-appearance: none;
          pointer-events: auto;
        //   width: 40px;
        //   height: 40px;
        //   border-radius: 20px;
          background: linear-gradient(to bottom, white, #f8f8f8);
          cursor: grab;
          box-shadow: 
            0 2px 8px rgba(0,0,0,0.15),
            inset 0 1px 0 rgba(255,255,255,0.8);
          border: 3px solid var(--primary-color, #03a9f4);
          position: relative;
          z-index: 10;
          margin-top: -6px;
          transition: transform 0.15s, box-shadow 0.15s;
        }

        .dual-range-input::-webkit-slider-thumb:hover {
          transform: scale(1.1);
          box-shadow: 
            0 4px 12px rgba(0,0,0,0.2),
            inset 0 1px 0 rgba(255,255,255,0.8);
        }

        .dual-range-input::-webkit-slider-thumb:active {
          cursor: grabbing;
          transform: scale(1.05);
        }

        .dual-range-input::-moz-range-thumb {
          pointer-events: auto;
          width: 40px;
          height: 40px;
          border-radius: 20px;
          background: linear-gradient(to bottom, white, #f8f8f8);
          cursor: grab;
          border: 3px solid var(--primary-color, #03a9f4);
          box-shadow: 
            0 2px 8px rgba(0,0,0,0.15),
            inset 0 1px 0 rgba(255,255,255,0.8);
          margin-top: -6px;
          transition: transform 0.15s, box-shadow 0.15s;
        }

        .dual-range-input::-moz-range-thumb:hover {
          transform: scale(1.1);
          box-shadow: 
            0 4px 12px rgba(0,0,0,0.2),
            inset 0 1px 0 rgba(255,255,255,0.8);
        }

        .dual-range-input:focus::-webkit-slider-thumb {
          box-shadow: 
            0 0 0 4px rgba(3, 169, 244, 0.2),
            0 2px 8px rgba(0,0,0,0.15),
            inset 0 1px 0 rgba(255,255,255,0.8);
        }

        .dual-range-input:focus::-moz-range-thumb {
          box-shadow: 
            0 0 0 4px rgba(3, 169, 244, 0.2),
            0 2px 8px rgba(0,0,0,0.15),
            inset 0 1px 0 rgba(255,255,255,0.8);
        }

        /* Heating input - red from left to thumb */
        .dual-range-input.heating::-webkit-slider-runnable-track {
          background: linear-gradient(to right, 
            #f44336 0%, 
            #f44336 var(--track-fill, 50%), 
            transparent var(--track-fill, 50%));
          height: 8px;
          border-radius: 4px;
          position: relative;
          z-index: 5;
        }

        .dual-range-input.heating::-moz-range-track {
          background: transparent;
          height: 8px;
          border-radius: 4px;
        }

        .dual-range-input.heating::-moz-range-progress {
          background: #f44336;
          height: 8px;
          border-radius: 4px 0 0 4px;
        }

        /* Cooling input - blue from right to thumb */
        .dual-range-input.cooling::-webkit-slider-runnable-track {
          background: linear-gradient(to left, 
            #2196f3 0%, 
            #2196f3 var(--track-fill, 50%), 
            transparent var(--track-fill, 50%));
          height: 8px;
          border-radius: 4px;
          position: relative;
          z-index: 5;
        }

        .dual-range-input.cooling::-moz-range-track {
          background: transparent;
          height: 8px;
          border-radius: 4px;
        }

        .dual-range-input.cooling::-moz-range-progress {
          background: #2196f3;
          height: 8px;
          border-radius: 0 4px 4px 0;
          transform: scaleX(-1);
          transform-origin: center;
        }

        /* Heat/Cool or Auto input - orange full track */
        .dual-range-input.heat-cool::-webkit-slider-runnable-track {
          background: #ff9800;
          height: 8px;
          border-radius: 4px;
          position: relative;
          z-index: 5;
        }

        .dual-range-input.heat-cool::-moz-range-track {
          background: #ff9800;
          height: 8px;
          border-radius: 4px;
        }

        .temp-range-labels {
          display: flex;
          justify-content: space-between;
          margin-top: 12px;
          padding: 0 10px;
        }

        .temp-range-value {
          display: flex;
          flex-direction: column;
          align-items: center;
        }

        .temp-range-label {
          font-size: 11px;
          color: #999;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          margin-bottom: 4px;
        }

        .temp-range-number {
          font-size: 24px;
          font-weight: 500;
          color: #333;
        }

        .mode-selector {
          display: flex;
          gap: 8px;
          flex-wrap: wrap;
        }

        .mode-select {
          width: 100%;
          padding: 10px 12px;
          border: 1px solid #ddd;
          border-radius: 4px;
          background: white;
          font-size: 14px;
          color: #333;
          cursor: pointer;
          outline: none;
          transition: border-color 0.2s;
        }

        .mode-select:hover {
          border-color: #999;
        }

        .mode-select:focus {
          border-color: var(--primary-color, #03a9f4);
          box-shadow: 0 0 0 2px rgba(3, 169, 244, 0.1);
        }

        .mode-row {
          display: flex;
          gap: 12px;
        }

        .mode-row .section {
          flex: 1;
        }

        .mode-chip {
          padding: 8px 16px;
          border: 2px solid var(--divider-color, #e0e0e0);
          border-radius: 16px;
          background: white;
          cursor: pointer;
          font-size: 13px;
          transition: all 0.2s;
        }

        .mode-chip:hover {
          border-color: var(--primary-color, #03a9f4);
        }

        .mode-chip.active {
          background: var(--primary-color, #03a9f4);
          color: white;
          border-color: var(--primary-color, #03a9f4);
        }

        .toggle-row {
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 12px 16px;
          background: #f9f9f9;
          border-radius: 8px;
        }

        .toggle-label {
          font-size: 14px;
          color: #333;
        }

        .toggle-switch {
          position: relative;
          width: 48px;
          height: 24px;
        }

        .toggle-switch input {
          opacity: 0;
          width: 0;
          height: 0;
        }

        .toggle-slider {
          position: absolute;
          cursor: pointer;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-color: #ccc;
          transition: 0.3s;
          border-radius: 24px;
        }

        .toggle-slider:before {
          position: absolute;
          content: "";
          height: 18px;
          width: 18px;
          left: 3px;
          bottom: 3px;
          background-color: white;
          transition: 0.3s;
          border-radius: 50%;
        }

        input:checked + .toggle-slider {
          background-color: var(--primary-color, #03a9f4);
        }

        input:checked + .toggle-slider:before {
          transform: translateX(24px);
        }

        .current-temp-display {
          text-align: center;
          padding: 16px;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          border-radius: 8px;
          color: white;
          margin-bottom: 16px;
        }

        .current-temp-label {
          font-size: 12px;
          opacity: 0.9;
          margin-bottom: 4px;
        }

        .current-temp-value {
          font-size: 36px;
          font-weight: 300;
        }

        .empty-state {
          text-align: center;
          padding: 40px;
          color: #999;
        }

        .empty-state-icon {
          font-size: 48px;
          margin-bottom: 16px;
        }
      `;

      constructor() {
        super();
        this.stateObj = this._createMockEntity(409); // Default: 1 + 8 + 16 + 128 + 256
      }

      // Helper to capitalize mode text
      _capitalize(text) {
        // Special case for heat_cool
        if (text === 'heat_cool') {
          return 'Heat/Cool';
        }
        return text.split('_').map(word => 
          word.charAt(0).toUpperCase() + word.slice(1)
        ).join(' ');
      }

      _createMockEntity(supportedFeatures, hvacModes = ['off', 'heat', 'cool', 'heat_cool', 'auto']) {
        const entity = {
          entity_id: 'climate.test_hvac',
          state: 'heat',
          attributes: {
            supported_features: supportedFeatures,
            hvac_modes: hvacModes,
            current_temperature: 21.5,
            temperature: 22.0,
            target_temp_high: 24.0,
            target_temp_low: 20.0,
            target_humidity: 50,
            current_humidity: 48,
            min_temp: 7,
            max_temp: 35,
            min_humidity: 30,
            max_humidity: 90,
          }
        };

        // Add optional attributes based on features
        if (supportsFeature(entity, ClimateEntityFeature.FAN_MODE)) {
          entity.attributes.fan_mode = 'auto';
          entity.attributes.fan_modes = ['auto', 'low', 'medium', 'high'];
        }

        if (supportsFeature(entity, ClimateEntityFeature.PRESET_MODE)) {
          entity.attributes.preset_mode = 'comfort';
          entity.attributes.preset_modes = ['eco', 'comfort', 'boost', 'sleep'];
        }

        if (supportsFeature(entity, ClimateEntityFeature.SWING_MODE)) {
          entity.attributes.swing_mode = 'off';
          entity.attributes.swing_modes = ['off', 'vertical', 'both'];
        }

        if (supportsFeature(entity, ClimateEntityFeature.SWING_HORIZONTAL_MODE)) {
          entity.attributes.swing_horizontal_mode = 'off';
          entity.attributes.swing_horizontal_modes = ['off', 'left', 'center', 'right'];
        }

        if (supportsFeature(entity, ClimateEntityFeature.AUX_HEAT)) {
          entity.attributes.aux_heat = 'off';
        }

        return entity;
      }

      updateEntity(supportedFeatures, hvacModes) {
        this.stateObj = this._createMockEntity(supportedFeatures, hvacModes);
      }

      render() {
        return html`
          <div class="dialog-header">
            <div class="entity-icon">üå°Ô∏è</div>
            <div>
              <div>${this.stateObj.entity_id}</div>
            </div>
          </div>

          ${this._renderModeRow()}
          ${this._renderTargetTemperature()}
          ${this._renderTargetTemperatureRange()}
          ${this._renderTargetHumidity()}
          ${this._renderFanSwingRow()}
          ${this._renderAuxHeat()}
        `;
      }

      _renderModeRow() {
        const hasPresetMode = supportsFeature(this.stateObj, ClimateEntityFeature.PRESET_MODE);
        
        if (!hasPresetMode) {
          return this._renderHvacModes();
        }
        
        return html`
          <div class="mode-row">
            ${this._renderHvacModes()}
            ${this._renderPresetModes()}
          </div>
        `;
      }

      _renderFanSwingRow() {
        const hasFanMode = supportsFeature(this.stateObj, ClimateEntityFeature.FAN_MODE);
        const hasSwingMode = supportsFeature(this.stateObj, ClimateEntityFeature.SWING_MODE);
        const hasSwingHorizontal = supportsFeature(this.stateObj, ClimateEntityFeature.SWING_HORIZONTAL_MODE);
        
        // If none are present, return nothing
        if (!hasFanMode && !hasSwingMode && !hasSwingHorizontal) {
          return '';
        }
        
        // If only one is present, show it full width
        if (hasFanMode && !hasSwingMode && !hasSwingHorizontal) {
          return this._renderFanModes();
        }
        if (!hasFanMode && hasSwingMode && !hasSwingHorizontal) {
          return this._renderSwingModes();
        }
        if (!hasFanMode && !hasSwingMode && hasSwingHorizontal) {
          return this._renderSwingHorizontalModes();
        }
        
        // Show all present modes in a row
        return html`
          <div class="mode-row">
            ${hasFanMode ? this._renderFanModes() : ''}
            ${hasSwingMode ? this._renderSwingModes() : ''}
            ${hasSwingHorizontal ? this._renderSwingHorizontalModes() : ''}
          </div>
        `;
      }

      _renderCurrentTemperature() {
        return html`
          <div class="current-temp-display">
            <div class="current-temp-label">Current Temperature</div>
            <div class="current-temp-value">
              ${this.stateObj.attributes.current_temperature}¬∞C
            </div>
          </div>
        `;
      }

      _renderHvacModes() {
        return html`
          <div class="section">
            <div class="section-title">HVAC Mode</div>
            <select 
              class="mode-select"
              .value=${this.stateObj.state}
              @change=${(e) => this._setHvacMode(e.target.value)}
            >
              ${this.stateObj.attributes.hvac_modes.map(mode => html`
                <option value="${mode}" ?selected=${this.stateObj.state === mode}>
                  ${this._capitalize(mode)}
                </option>
              `)}
            </select>
          </div>
        `;
      }

      _renderTargetTemperature() {
        if (!supportsFeature(this.stateObj, ClimateEntityFeature.TARGET_TEMPERATURE)) {
          return '';
        }

        const { min_temp, max_temp, temperature, hvac_modes } = this.stateObj.attributes;
        const range = max_temp - min_temp;
        const tempPercent = ((temperature - min_temp) / range) * 100;

        // Use the currently selected HVAC mode to determine styling
        const currentMode = this.stateObj.state;

        // Determine class, track fill, and label based on current mode
        let inputClass, trackFill, label;
        
        if (currentMode === 'heat_cool') {
          inputClass = 'heat-cool';
          trackFill = tempPercent;
          label = 'Set to';
        } else if (currentMode === 'cool') {
          inputClass = 'cooling';
          trackFill = 100 - tempPercent;
          label = 'Cool to';
        } else if (currentMode === 'auto') {
          inputClass = '';  // No color styling for auto
          trackFill = tempPercent;
          label = 'Set to';
        } else if (currentMode === 'heat') {
          inputClass = 'heating';
          trackFill = tempPercent;
          label = 'Heat to';
        } else {
          // Off or other modes - no color styling
          inputClass = '';
          trackFill = tempPercent;
          label = 'Set to';
        }

        return html`
          <div class="section">
            <div class="section-title">Target Temperature</div>
            <div class="temp-range-control">
              <div class="temp-range-labels" style="justify-content: center;">
                <div class="temp-range-value">
                  <span class="temp-range-label">${label}</span>
                  <span class="temp-range-number">${temperature}¬∞</span>
                </div>
              </div>
              <div class="dual-range-container">
                <input 
                  type="range" 
                  class="dual-range-input ${inputClass}"
                  min="${min_temp}"
                  max="${max_temp}"
                  step="0.5"
                  .value="${temperature}"
                  @input=${this._handleTempSlider}
                  style="top: 0; --track-fill: ${trackFill}%;"
                />
              </div>
            </div>
          </div>
        `;
      }

      _renderTargetTemperatureRange() {
        if (!supportsFeature(this.stateObj, ClimateEntityFeature.TARGET_TEMPERATURE_RANGE)) {
          return '';
        }

        const { min_temp, max_temp, target_temp_low, target_temp_high, hvac_modes } = this.stateObj.attributes;
        const range = max_temp - min_temp;
        const lowPercent = ((target_temp_low - min_temp) / range) * 100;
        const highPercent = ((target_temp_high - min_temp) / range) * 100;

        // Use the currently selected HVAC mode to determine layout
        const currentMode = this.stateObj.state;
        
        // Determine if we need dual range or single based on current mode
        const heatOnly = currentMode === 'heat';
        const coolOnly = currentMode === 'cool';
        const isOffOrAuto = currentMode === 'off' || currentMode === 'auto';

        // Render heat only (single input with red track)
        if (heatOnly) {
          return html`
            <div class="section">
              <div class="section-title">Target Temperature</div>
              <div class="temp-range-control">
                <div class="temp-range-labels" style="justify-content: center;">
                  <div class="temp-range-value">
                    <span class="temp-range-label">Heat to</span>
                    <span class="temp-range-number">${target_temp_low}¬∞</span>
                  </div>
                </div>
                <div class="dual-range-container">
                  <input 
                    type="range" 
                    class="dual-range-input heating"
                    min="${min_temp}"
                    max="${max_temp}"
                    step="0.5"
                    .value="${target_temp_low}"
                    @input=${this._handleTempLowSlider}
                    style="top: 0; --track-fill: ${lowPercent}%;"
                  />
                </div>
              </div>
            </div>
          `;
        }

        // Render cool only (single input with blue track)
        if (coolOnly) {
          return html`
            <div class="section">
              <div class="section-title">Target Temperature</div>
              <div class="temp-range-control">
                <div class="temp-range-labels" style="justify-content: center;">
                  <div class="temp-range-value">
                    <span class="temp-range-label">Cool to</span>
                    <span class="temp-range-number">${target_temp_high}¬∞</span>
                  </div>
                </div>
                <div class="dual-range-container">
                  <input 
                    type="range" 
                    class="dual-range-input cooling"
                    min="${min_temp}"
                    max="${max_temp}"
                    step="0.5"
                    .value="${target_temp_high}"
                    @input=${this._handleTempHighSlider}
                    style="top: 0; --track-fill: ${100 - highPercent}%;"
                  />
                </div>
              </div>
            </div>
          `;
        }

        // Render dual range (both heat and cool, heat_cool, auto, or off)
        return html`
          <div class="section">
            <div class="section-title">Temperature Range</div>
            <div class="temp-range-control">
              <div class="temp-range-labels">
                <div class="temp-range-value">
                  <span class="temp-range-label">Heat to</span>
                  <span class="temp-range-number">${target_temp_low}¬∞</span>
                </div>
                <div class="temp-range-value">
                  <span class="temp-range-label">Cool to</span>
                  <span class="temp-range-number">${target_temp_high}¬∞</span>
                </div>
              </div>
              <div class="dual-range-container">
                ${!isOffOrAuto ? html`
                  <div class="dual-range-fill" 
                    style="left: ${lowPercent}%; width: ${highPercent - lowPercent}%">
                  </div>
                ` : ''}
                <input 
                  type="range" 
                  class="dual-range-input ${!isOffOrAuto ? 'heating' : ''}"
                  min="${min_temp}"
                  max="${max_temp}"
                  step="0.5"
                  .value="${target_temp_low}"
                  @input=${this._handleTempLowSlider}
                  style="top: 0; --track-fill: ${lowPercent}%;"
                />
                <input 
                  type="range" 
                  class="dual-range-input ${!isOffOrAuto ? 'cooling' : ''}"
                  min="${min_temp}"
                  max="${max_temp}"
                  step="0.5"
                  .value="${target_temp_high}"
                  @input=${this._handleTempHighSlider}
                  style="top: 0; --track-fill: ${100 - highPercent}%;"
                />
              </div>
            </div>
          </div>
        `;
      }

      _renderTargetHumidity() {
        if (!supportsFeature(this.stateObj, ClimateEntityFeature.TARGET_HUMIDITY)) {
          return '';
        }

        const { min_humidity, max_humidity, target_humidity } = this.stateObj.attributes;
        const range = max_humidity - min_humidity;
        const humidityPercent = ((target_humidity - min_humidity) / range) * 100;

        return html`
          <div class="section">
            <div class="section-title">Target Humidity</div>
            <div class="temp-range-control">
              <div class="temp-range-labels" style="justify-content: center;">
                <div class="temp-range-value">
                  <span class="temp-range-label">Set to</span>
                  <span class="temp-range-number">${target_humidity}%</span>
                </div>
              </div>
              <div class="dual-range-container">
                <input 
                  type="range" 
                  class="dual-range-input"
                  min="${min_humidity}"
                  max="${max_humidity}"
                  step="1"
                  .value="${target_humidity}"
                  @input=${this._handleHumiditySlider}
                  style="top: 0; --track-fill: ${humidityPercent}%;"
                />
              </div>
            </div>
          </div>
        `;
      }

      _renderFanModes() {
        if (!supportsFeature(this.stateObj, ClimateEntityFeature.FAN_MODE)) {
          return '';
        }

        return html`
          <div class="section">
            <div class="section-title">Fan Mode</div>
            <select 
              class="mode-select"
              .value=${this.stateObj.attributes.fan_mode}
              @change=${(e) => this._setFanMode(e.target.value)}
            >
              ${this.stateObj.attributes.fan_modes.map(mode => html`
                <option value="${mode}" ?selected=${this.stateObj.attributes.fan_mode === mode}>
                  ${this._capitalize(mode)}
                </option>
              `)}
            </select>
          </div>
        `;
      }

      _renderPresetModes() {
        if (!supportsFeature(this.stateObj, ClimateEntityFeature.PRESET_MODE)) {
          return '';
        }

        return html`
          <div class="section">
            <div class="section-title">Preset Mode</div>
            <select 
              class="mode-select"
              .value=${this.stateObj.attributes.preset_mode}
              @change=${(e) => this._setPresetMode(e.target.value)}
            >
              ${this.stateObj.attributes.preset_modes.map(mode => html`
                <option value="${mode}" ?selected=${this.stateObj.attributes.preset_mode === mode}>
                  ${this._capitalize(mode)}
                </option>
              `)}
            </select>
          </div>
        `;
      }

      _renderSwingModes() {
        if (!supportsFeature(this.stateObj, ClimateEntityFeature.SWING_MODE)) {
          return '';
        }

        return html`
          <div class="section">
            <div class="section-title">Swing (Vertical)</div>
            <select 
              class="mode-select"
              .value=${this.stateObj.attributes.swing_mode}
              @change=${(e) => this._setSwingMode(e.target.value)}
            >
              ${this.stateObj.attributes.swing_modes.map(mode => html`
                <option value="${mode}" ?selected=${this.stateObj.attributes.swing_mode === mode}>
                  ${this._capitalize(mode)}
                </option>
              `)}
            </select>
          </div>
        `;
      }

      _renderSwingHorizontalModes() {
        if (!supportsFeature(this.stateObj, ClimateEntityFeature.SWING_HORIZONTAL_MODE)) {
          return '';
        }

        return html`
          <div class="section">
            <div class="section-title">Swing (Horizontal)</div>
            <select 
              class="mode-select"
              .value=${this.stateObj.attributes.swing_horizontal_mode}
              @change=${(e) => this._setSwingHorizontalMode(e.target.value)}
            >
              ${this.stateObj.attributes.swing_horizontal_modes.map(mode => html`
                <option value="${mode}" ?selected=${this.stateObj.attributes.swing_horizontal_mode === mode}>
                  ${this._capitalize(mode)}
                </option>
              `)}
            </select>
          </div>
        `;
      }

      _renderAuxHeat() {
        if (!supportsFeature(this.stateObj, ClimateEntityFeature.AUX_HEAT)) {
          return '';
        }

        return html`
          <div class="section">
            <div class="section-title">Auxiliary Heat</div>
            <div class="toggle-row">
              <span class="toggle-label">Aux Heat</span>
              <label class="toggle-switch">
                <input 
                  type="checkbox" 
                  .checked=${this.stateObj.attributes.aux_heat === 'on'}
                  @change=${this._toggleAuxHeat}
                />
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>
        `;
      }

      // Event handlers (mock implementations)
      _setHvacMode(mode) {
        this.stateObj = { ...this.stateObj, state: mode };
        this.requestUpdate();
        console.log('Set HVAC mode:', mode);
      }

      _adjustTemp(delta) {
        const newTemp = Math.max(
          this.stateObj.attributes.min_temp,
          Math.min(this.stateObj.attributes.max_temp, this.stateObj.attributes.temperature + delta)
        );
        this.stateObj.attributes.temperature = newTemp;
        this.requestUpdate();
        console.log('Set temperature:', newTemp);
      }

      _handleTempSlider(e) {
        this.stateObj.attributes.temperature = parseFloat(e.target.value);
        this.requestUpdate();
      }

      _handleTempHighSlider(e) {
        this.stateObj.attributes.target_temp_high = parseFloat(e.target.value);
        this.requestUpdate();
      }

      _handleTempLowSlider(e) {
        this.stateObj.attributes.target_temp_low = parseFloat(e.target.value);
        this.requestUpdate();
      }

      _adjustHumidity(delta) {
        const newHumidity = Math.max(
          this.stateObj.attributes.min_humidity,
          Math.min(this.stateObj.attributes.max_humidity, this.stateObj.attributes.target_humidity + delta)
        );
        this.stateObj.attributes.target_humidity = newHumidity;
        this.requestUpdate();
        console.log('Set humidity:', newHumidity);
      }

      _handleHumiditySlider(e) {
        this.stateObj.attributes.target_humidity = parseInt(e.target.value);
        this.requestUpdate();
      }

      _setFanMode(mode) {
        this.stateObj.attributes.fan_mode = mode;
        this.requestUpdate();
        console.log('Set fan mode:', mode);
      }

      _setPresetMode(mode) {
        this.stateObj.attributes.preset_mode = mode;
        this.requestUpdate();
        console.log('Set preset mode:', mode);
      }

      _setSwingMode(mode) {
        this.stateObj.attributes.swing_mode = mode;
        this.requestUpdate();
        console.log('Set swing mode:', mode);
      }

      _setSwingHorizontalMode(mode) {
        this.stateObj.attributes.swing_horizontal_mode = mode;
        this.requestUpdate();
        console.log('Set swing horizontal mode:', mode);
      }

      _toggleAuxHeat(e) {
        this.stateObj.attributes.aux_heat = e.target.checked ? 'on' : 'off';
        this.requestUpdate();
        console.log('Aux heat:', this.stateObj.attributes.aux_heat);
      }
    }

    customElements.define('climate-control-dialog', ClimateControlDialog);

    // Initialize controller
    function initController() {
      const dialog = document.querySelector('climate-control-dialog');
      const featureCheckboxes = document.querySelectorAll('input[type="checkbox"]:not(.hvac-mode-toggle):not(.temp-mode)');
      const tempModeCheckboxes = document.querySelectorAll('.temp-mode');
      const hvacModeCheckboxes = document.querySelectorAll('.hvac-mode-toggle');
      const updateBtn = document.getElementById('updateBtn');
      const resetBtn = document.getElementById('resetBtn');
      const supportedFeaturesDisplay = document.getElementById('supportedFeatures');

      // Make temperature mode checkboxes mutually exclusive
      tempModeCheckboxes.forEach(cb => {
        cb.addEventListener('change', (e) => {
          if (e.target.checked) {
            tempModeCheckboxes.forEach(otherCb => {
              if (otherCb !== e.target) {
                otherCb.checked = false;
              }
            });
          }
          updateDialog();
        });
      });

      function calculateFeatures() {
        let features = 0;
        // Include temp mode checkboxes
        tempModeCheckboxes.forEach(cb => {
          if (cb.checked) {
            features |= parseInt(cb.value);
          }
        });
        // Include other feature checkboxes
        featureCheckboxes.forEach(cb => {
          if (cb.checked) {
            features |= parseInt(cb.value);
          }
        });
        return features;
      }

      function getSelectedHvacModes() {
        const modes = [];
        hvacModeCheckboxes.forEach(cb => {
          if (cb.checked) {
            modes.push(cb.value);
          }
        });
        return modes.length > 0 ? modes : ['off'];
      }

      function updateDialog() {
        const features = calculateFeatures();
        const hvacModes = getSelectedHvacModes();
        supportedFeaturesDisplay.textContent = features;
        dialog.updateEntity(features, hvacModes);
        console.log('Updated features:', features);
        console.log('Updated HVAC modes:', hvacModes);
      }

      function reset() {
        // Default features: 2 + 8 + 16 + 128 + 256 = 410
        const defaultFeatures = [2, 8, 16, 128, 256];
        const defaultModes = ['off', 'heat', 'cool', 'heat_cool', 'auto'];
        
        tempModeCheckboxes.forEach(cb => {
          cb.checked = defaultFeatures.includes(parseInt(cb.value));
        });
        featureCheckboxes.forEach(cb => {
          cb.checked = defaultFeatures.includes(parseInt(cb.value));
        });
        hvacModeCheckboxes.forEach(cb => {
          cb.checked = defaultModes.includes(cb.value);
        });
        updateDialog();
      }

      // Event listeners
      updateBtn.addEventListener('click', updateDialog);
      resetBtn.addEventListener('click', reset);
      
      featureCheckboxes.forEach(cb => {
        cb.addEventListener('change', () => {
          const features = calculateFeatures();
          supportedFeaturesDisplay.textContent = features;
        });
      });
      
      // Note: tempModeCheckboxes already have change listeners above
      
      hvacModeCheckboxes.forEach(cb => {
        cb.addEventListener('change', updateDialog);
      });

      // Initial update
      updateDialog();

      // Modal controls
      const modalOverlay = document.getElementById('modalOverlay');
      const openModalBtn = document.getElementById('openModalBtn');
      const modalClose = document.getElementById('modalClose');
      const modalDialogContainer = document.getElementById('modalDialogContainer');
      
      function openModal() {
        const mainDialog = document.querySelector('climate-control-dialog');
        
        if (!mainDialog || !mainDialog.stateObj) {
          console.error('Main dialog or state not available');
          return;
        }
        
        // Clear and create new modal dialog element
        modalDialogContainer.innerHTML = '';
        const modalDialog = document.createElement('climate-control-dialog');
        modalDialog.id = 'modalDialog';
        
        // Append first, then set state after it's connected
        modalDialogContainer.appendChild(modalDialog);
        
        // Set state directly (no need for requestAnimationFrame with property setter)
        // Deep clone to avoid reference issues
        const clonedState = {
          entity_id: mainDialog.stateObj.entity_id,
          state: mainDialog.stateObj.state,
          attributes: {
            ...mainDialog.stateObj.attributes,
            supported_features: mainDialog.stateObj.attributes.supported_features
          }
        };
        
        modalDialog.stateObj = clonedState;
        
        modalOverlay.classList.add('active');
      }
      
      function closeModal() {
        modalOverlay.classList.remove('active');
      }
      
      openModalBtn.addEventListener('click', openModal);
      modalClose.addEventListener('click', closeModal);
      
      // Close modal when clicking outside the dialog
      modalOverlay.addEventListener('click', (e) => {
        if (e.target === modalOverlay) {
          closeModal();
        }
      });
      
      // Close modal on Escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modalOverlay.classList.contains('active')) {
          closeModal();
        }
      });
    }

    // Wait for DOM to be ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initController);
    } else {
      initController();
    }
  </script>

  <!-- Modal overlay -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal-dialog">
      <button class="modal-close" id="modalClose">&times;</button>
      <div id="modalDialogContainer"></div>
    </div>
  </div>
</body>
</html>

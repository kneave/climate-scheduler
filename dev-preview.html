<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Climate Scheduler - Dev Preview</title>
    <link rel="stylesheet" href="../custom_components/climate_scheduler/frontend/styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ”¥ Climate Scheduler (Development Preview)</h1>
            <p style="color: #ff9800; font-size: 0.9rem;">âš ï¸ Frontend preview only - HA API not connected</p>
        </header>

        <section class="entity-selector">
            <div class="selector-header">
                <h2>Climate Entities</h2>
                <button id="refresh-entities" class="btn-icon" title="Refresh">â†»</button>
            </div>
            <div id="entity-list" class="entity-list">
                <!-- Mock data for preview -->
                <div class="entity-card selected" data-entity-id="climate.living_room">
                    <div class="entity-name">Living Room Thermostat</div>
                    <div class="entity-id">climate.living_room</div>
                    <div class="entity-temp">20.5Â°C â†’ 21.0Â°C</div>
                    <div class="entity-status">heat</div>
                </div>
                <div class="entity-card" data-entity-id="climate.bedroom">
                    <div class="entity-name">Bedroom Thermostat</div>
                    <div class="entity-id">climate.bedroom</div>
                    <div class="entity-temp">19.0Â°C â†’ 19.0Â°C</div>
                    <div class="entity-status">idle</div>
                </div>
                <div class="entity-card" data-entity-id="climate.office">
                    <div class="entity-name">Office Thermostat</div>
                    <div class="entity-id">climate.office</div>
                    <div class="entity-temp">18.5Â°C â†’ 20.0Â°C</div>
                    <div class="entity-status">heat</div>
                </div>
            </div>
        </section>

        <section class="schedule-editor" id="schedule-editor">
            <div class="editor-header">
                <h2 id="current-entity-name">Living Room Thermostat</h2>
                <div class="editor-controls">
                    <label class="toggle-switch">
                        <input type="checkbox" id="schedule-enabled" checked>
                        <span class="slider"></span>
                        <span class="toggle-label">Enabled</span>
                    </label>
                    <button id="save-schedule" class="btn-primary">Save (Preview Only)</button>
                </div>
            </div>

            <div class="entity-status">
                <div class="status-item">
                    <span class="status-label">Current Temp:</span>
                    <span id="current-temp" class="status-value">20.5Â°C</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Target Temp:</span>
                    <span id="target-temp" class="status-value">21.0Â°C</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Scheduled Temp:</span>
                    <span id="scheduled-temp" class="status-value">21.0Â°C</span>
                </div>
            </div>

            <div class="graph-container">
                <div class="graph-wrapper">
                    <svg id="temperature-graph" viewBox="0 0 800 400">
                        <!-- Dynamically generated -->
                    </svg>
                </div>
                <div class="graph-instructions">
                    <p>ğŸ“ <strong>Tap/Click</strong> on the graph to add a temperature point</p>
                    <p>ğŸ‘† <strong>Drag</strong> points up or down to adjust temperature</p>
                    <p>âœ–ï¸ <strong>Double-tap/click</strong> a point to remove it</p>
                </div>
            </div>
        </section>

        <footer>
            <p>Climate Scheduler v1.0.0 - Development Preview</p>
        </footer>
    </div>

    <script src="../custom_components/climate_scheduler/frontend/graph.js"></script>
    <script>
        // Initialize graph with default data for preview
        let graph;
        
        function initPreview() {
            const svgElement = document.getElementById('temperature-graph');
            graph = new TemperatureGraph(svgElement);
            
            // Load default schedule
            graph.setNodes([
                { time: '00:00', temp: 18 },
                { time: '07:00', temp: 21 },
                { time: '23:00', temp: 18 }
            ]);
            
            // Listen for changes
            svgElement.addEventListener('nodesChanged', (event) => {
                console.log('Nodes changed:', event.detail.nodes);
                updateScheduledTemp();
            });
            
            // Mock save button
            document.getElementById('save-schedule').addEventListener('click', () => {
                const nodes = graph.getNodes();
                console.log('Would save schedule:', nodes);
                alert('Preview mode - Schedule logged to console');
            });
            
            updateScheduledTemp();
        }
        
        function updateScheduledTemp() {
            const now = new Date();
            const currentTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            const nodes = graph.getNodes();
            
            if (nodes.length > 0) {
                const temp = interpolateTemperature(nodes, currentTime);
                document.getElementById('scheduled-temp').textContent = `${temp.toFixed(1)}Â°C`;
            }
        }
        
        function interpolateTemperature(nodes, timeStr) {
            if (nodes.length === 0) return 18;
            
            const sorted = [...nodes].sort((a, b) => timeToMinutes(a.time) - timeToMinutes(b.time));
            const currentMinutes = timeToMinutes(timeStr);
            
            let before = null, after = null;
            
            for (let i = 0; i < sorted.length; i++) {
                const nodeMinutes = timeToMinutes(sorted[i].time);
                if (nodeMinutes <= currentMinutes) before = sorted[i];
                if (nodeMinutes > currentMinutes && !after) after = sorted[i];
            }
            
            if (!before) {
                before = sorted[sorted.length - 1];
                after = sorted[0];
            } else if (!after) {
                before = sorted[sorted.length - 1];
                after = sorted[0];
            }
            
            const beforeMin = timeToMinutes(before.time);
            const afterMin = timeToMinutes(after.time);
            const adjustedAfterMin = afterMin <= beforeMin ? afterMin + 1440 : afterMin;
            
            const ratio = (currentMinutes - beforeMin) / (adjustedAfterMin - beforeMin);
            return before.temp + ratio * (after.temp - before.temp);
        }
        
        function timeToMinutes(timeStr) {
            const [h, m] = timeStr.split(':').map(Number);
            return h * 60 + m;
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initPreview);
        } else {
            initPreview();
        }
        
        setInterval(updateScheduledTemp, 60000);
    </script>
</body>
</html>
